# nav2_params.yaml — GPS-only / dynamic localization (no static map)

# -------------------------------
# Map server (explicitly disabled)
# -------------------------------
map_server:
  ros__parameters:
    enabled: false
    yaml_filename: ""        
    frame_id: "map"
    topic_name: "map"
    use_sim_time: false

amcl:
  ros__parameters:
    enabled: false

# -------------------------------
# Lifecycle managers
# -------------------------------
lifecycle_manager_localization:
  ros__parameters:
    use_sim_time: false
    autostart: false         # DO NOT autostart localization manager (avoids configuring map_server)
    #node_names: []         # leave empty / default

lifecycle_manager_navigation:
  ros__parameters:
    use_sim_time: false
    autostart: true         # start navigation-related lifecycle nodes
    node_names: 
      - 'controller_server'
      - 'planner_server'
      - 'behavior_server'
      - 'bt_navigator'
      - 'waypoint_follower'
      - 'velocity_smoother'
      - 'collision_monitor'
    # Explicitly exclude docking_server to prevent charging dock plugin errors

# -------------------------------
# Behaviour Tree / BT Navigator
# -------------------------------
# bt_navigator:
#   ros__parameters:
#     use_sim_time: false
#     default_bt_xml_filename: "navigate_to_pose_w_replanning_and_recovery.xml"
#     enable_groot_monitoring: false
#     plugin_lib_names:
#       - nav2_behavior_tree::NavigateToPoseAction
#       - nav2_behavior_tree::WaitAction
#       - nav2_behavior_tree::ClearEntireCostmapService
#       - nav2_behavior_tree::FollowPathAction
#       - nav2_behavior_tree::BackUpAction
bt_navigator:
  ros__parameters:
    use_sim_time: false
    default_bt_xml_filename: "navigate_to_pose_w_replanning_and_recovery.xml"
    enable_groot_monitoring: false

# -------------------------------
# Controller Server (Jazzy — explicit goal & progress checker blocks required)
# TODO: NATHAN make sure this server launches properly
# -------------------------------
controller_server:
  ros__parameters:
    use_sim_time: false
    global_frame: odom
    controller_frequency: 10.0
    min_theta_velocity_threshold: 0.001

    # Jazzy requires explicit names for these plugins (exactly as used below)
    progress_checker_plugins: ["progress_checker"]
    goal_checker_plugins: ["goal_checker"]

    progress_checker:
      plugin: "nav2_controller::SimpleProgressChecker"

    goal_checker:
      plugin: "nav2_controller::SimpleGoalChecker"
      xy_goal_tolerance: 0.5
      yaw_goal_tolerance: 0.25

    controller_plugins: ["FollowPath"]

    FollowPath:
      plugin: "nav2_regulated_pure_pursuit_controller::RegulatedPurePursuitController"
      desired_linear_vel: 0.6
      lookahead_dist: 2.0
      min_lookahead_dist: 0.5
      max_lookahead_dist: 4.0
      use_velocity_scaled_lookahead_dist: true
      rotate_to_heading_angular_vel: 0.5
      transform_tolerance: 0.3
      allow_reversing: false
      use_interpolation: true
      use_rotate_to_heading: true
      max_angular_accel: 1.0
      min_approach_linear_velocity: 0.1
      goal_dist_tol: 0.5
      goal_yaw_tol: 0.25

# -------------------------------
# Local Costmap (for controller_server)
# -------------------------------
local_costmap:
  local_costmap:
    ros__parameters:
      use_sim_time: false
      global_frame: odom
      robot_base_frame: base_link
      update_frequency: 5.0
      publish_frequency: 5.0
      rolling_window: true
      width: 10
      height: 10
      resolution: 0.05
      # robot_radius: 0.25
      always_send_full_costmap: true

      plugins: ["obstacle_layer", "inflation_layer"]

      obstacle_layer:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        observation_sources: scan
        scan:
          topic: /scan
          sensor_frame: laser_frame
          data_type: LaserScan
          marking: true
          clearing: true
          obstacle_range: 6.0
          raytrace_range: 8.0
          min_obstacle_height: 0.0
          max_obstacle_height: 2.0

      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        cost_scaling_factor: 10.0
        inflation_radius: 0.4

# -------------------------------
# Planner Server
# -------------------------------
planner_server:
  ros__parameters:
    frame_id: odom
    use_sim_time: false
    planner_frequency: 1.0
    expected_planner_frequency: 1.0
    tolerance: 2.0
    planner_plugins: ["GridBased"]

    GridBased:
      plugin: "nav2_navfn_planner::NavfnPlanner"
      use_astar: false
      allow_unknown: true

# -------------------------------
# Global Costmap (for planner_server)
# -------------------------------
global_costmap:
  global_costmap:
    ros__parameters:
      use_sim_time: false
      global_frame: odom
      robot_base_frame: base_link
      update_frequency: 1.0
      publish_frequency: 1.0
      resolution: 0.5
      width: 80
      height: 80
      robot_radius: 0.25
      rolling_window: true
      always_send_full_costmap: true

      plugins: ["obstacle_layer", "inflation_layer"]

      obstacle_layer:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        observation_sources: scan
        scan:
          topic: /scan
          sensor_frame: laser_frame
          data_type: LaserScan
          marking: true
          clearing: true
          obstacle_range: 10.0
          raytrace_range: 12.0
          min_obstacle_height: 0.0
          max_obstacle_height: 2.0

      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        cost_scaling_factor: 10.0
        inflation_radius: 0.6

# -------------------------------
# Recovery Behaviors
# -------------------------------
recoveries_server:
  ros__parameters:
    costmap_clear_frequency: 1.0
    recovery_plugins: ["spin", "backup", "wait"]

    spin:
      plugin: "nav2_behaviors::Spin"
    backup:
      plugin: "nav2_behaviors::BackUp"
    wait:
      plugin: "nav2_behaviors::Wait"

# -------------------------------
# Waypoint Follower
# -------------------------------
waypoint_follower:
  ros__parameters:
    use_sim_time: false
    loop_rate: 5
    stop_on_failure: true
    interpolation_method: "linear"





# -------------------------------
# Collision Monitor
# -------------------------------
collision_monitor:
  ros__parameters:
    use_sim_time: false
    base_frame_id: "base_link"
    odom_frame_id: "odom"
    cmd_vel_in_topic: "cmd_vel_smoothed"
    cmd_vel_out_topic: "cmd_vel"
    state_topic: "collision_monitor_state"
    transform_tolerance: 0.2
    source_timeout: 1.0
    base_shift_correction: true
    stop_pub_timeout: 2.0
    
    # Polygons for collision detection
    polygons: ["FootprintApproach"]
    
    FootprintApproach:
      type: "polygon"
      action_type: "approach"
      footprint_topic: "/local_costmap/published_footprint"
      time_before_collision: 1.2
      simulation_time_step: 0.1
      min_points: 4
      visualize: false
      enabled: true
    
    # Observation sources (lidar)
    observation_sources: ["scan"]
    
    scan:
      type: "scan"
      topic: "/scan"
      min_height: 0.05
      max_height: 2.0
      enabled: true

# -------------------------------
# Velocity Smoother
# -------------------------------
velocity_smoother:
  ros__parameters:
    use_sim_time: false
    smoothing_frequency: 20.0
    scale_velocities: false
    feedback: "OPEN_LOOP"
    max_velocity: [0.8, 0.0, 1.0]
    min_velocity: [-0.5, 0.0, -1.0]
    max_accel: [1.5, 0.0, 2.0]
    max_decel: [-2.0, 0.0, -2.5]
    odom_topic: "odometry/filtered"
    odom_duration: 0.1
    deadband_velocity: [0.0, 0.0, 0.0]
    velocity_timeout: 1.0
